# THanks https://github.com/fox-it/cisco-ios-xe-implant-detection
# quick and dirty script by UK_Daniel_Card (aka mRr3b00t)
# just to show how you can do this in PSH
# releated to an implant deployed by threat actrs using: 

# CVE-2023-20198 IOS XE Web UI PE
# CVE-2023-20109 Cisco IOS and IOS XE Group Encrypted Transport VPN Out-of-Bounds Write Vulnerability
# Hack4Good !

$target = "https://192.168.0.99/"

add-type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint srvPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy


$response = Invoke-WebRequest -Uri $target -UserAgent ([Microsoft.PowerShell.Commands.PSUserAgent]::Chrome)

#$response.BaseResponse


#Shodan uses MurmurHash3 for html hashes - PSH does not have a cmdlet for this

$stringAsStream = [System.IO.MemoryStream]::new()
$writer = [System.IO.StreamWriter]::new($stringAsStream)
$writer.write($response.Content)
$writer.Flush()
$stringAsStream.Position = 0
$hash = Get-FileHash -InputStream $stringAsStream -Algorithm MD5 | Select-Object Hash

if($hash = "4ADA2BE6F16E1623DE939ACAE87EA6E7"){

write-host "CISCO IOS XE Found" -ForegroundColor Green
$response.Content

$target1 = "$target%25"

$response1 = Invoke-WebRequest -Uri $target1 -UserAgent ([Microsoft.PowerShell.Commands.PSUserAgent]::Chrome)
$response1

$stringAsStream = [System.IO.MemoryStream]::new()
$writer = [System.IO.StreamWriter]::new($stringAsStream)
$writer.write($response2.Content)
$writer.Flush()
$stringAsStream.Position = 0
$hash1 = Get-FileHash -InputStream $stringAsStream -Algorithm MD5 | Select-Object Hash1

if($hash1 = "4ADA2BE6F16E1623DE939ACAE87EA6E7"){ write-host "Implant likely not in place" -ForegroundColor Green}else{write-host "Implant Detected" -ForegroundColor Red}

}
